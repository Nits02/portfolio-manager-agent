name: Data Validation Pipeline

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to validate'
        required: true
        default: 'dev'
        type: string
      tickers:
        description: 'Comma-separated list of tickers to validate'
        required: false
        default: 'AAPL,MSFT'
        type: string
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to validate'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      tickers:
        description: 'Comma-separated list of tickers to validate'
        required: false
        default: 'AAPL,MSFT'
        type: string
  workflow_run:
    workflows: ["Feature Engineering Pipeline"]
    types:
      - completed

env:
  DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
  DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

jobs:
  validate-data-quality:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'prod' }}
    steps:
    - uses: actions/checkout@v4

    - name: Install Databricks CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh

    - name: Configure Databricks CLI
      run: |
        echo "${{ env.DATABRICKS_HOST }}" > ~/.databricks-host
        echo "${{ env.DATABRICKS_TOKEN }}" > ~/.databricks-token
        databricks configure --host "$(cat ~/.databricks-host)" --token "$(cat ~/.databricks-token)"

    - name: Run data validation
      id: validation
      run: |
        # Set default tickers if not provided
        TICKERS="${{ github.event.inputs.tickers || 'AAPL,MSFT,GOOGL,AMZN,META' }}"
        
        # Create validation job configuration
        envsubst < infra/job_validate_features.json > validation_config.json
        
        # Create and run validation job
        VALIDATION_JOB_ID=$(databricks jobs create --json-file validation_config.json | jq -r '.job_id')
        echo "validation_job_id=$VALIDATION_JOB_ID" >> $GITHUB_OUTPUT
        echo "Created validation job with ID: $VALIDATION_JOB_ID"
        
        # Run the validation
        VALIDATION_RUN_ID=$(databricks jobs run-now --job-id $VALIDATION_JOB_ID | jq -r '.run_id')
        echo "validation_run_id=$VALIDATION_RUN_ID" >> $GITHUB_OUTPUT
        echo "Started validation run with ID: $VALIDATION_RUN_ID"
        
        # Wait for completion with timeout
        echo "Waiting for validation to complete..."
        timeout 900 bash -c '
          while true; do
            STATUS=$(databricks runs get --run-id '$VALIDATION_RUN_ID' | jq -r ".state.life_cycle_state")
            echo "Validation status: $STATUS ($(date))"
            
            if [ "$STATUS" = "TERMINATED" ]; then
              RESULT=$(databricks runs get --run-id '$VALIDATION_RUN_ID' | jq -r ".state.result_state")
              echo "Final result: $RESULT"
              
              if [ "$RESULT" = "SUCCESS" ]; then
                echo "✅ Data validation completed successfully"
                exit 0
              else
                echo "❌ Data validation failed with result: $RESULT"
                databricks runs get --run-id '$VALIDATION_RUN_ID' | jq -r ".state.state_message" || echo "No error message available"
                exit 1
              fi
            elif [ "$STATUS" = "INTERNAL_ERROR" ] || [ "$STATUS" = "SKIPPED" ]; then
              echo "❌ Validation failed with status: $STATUS"
              exit 1
            fi
            
            sleep 15
          done
        '
      env:
        TICKERS: ${{ github.event.inputs.tickers || 'AAPL,MSFT,GOOGL,AMZN,META' }}
        CLUSTER_POLICY_ID: ${{ secrets.CLUSTER_POLICY_ID }}

    - name: Get validation output
      if: always()
      run: |
        echo "=== Validation Output ==="
        if [ -n "${{ steps.validation.outputs.validation_run_id }}" ]; then
          databricks runs get-output --run-id ${{ steps.validation.outputs.validation_run_id }} | jq -r '.notebook_output.result' || echo "No output available"
        else
          echo "No run ID available"
        fi

    - name: Clean up validation job
      if: always()
      run: |
        if [ -n "${{ steps.validation.outputs.validation_job_id }}" ]; then
          echo "Cleaning up validation job: ${{ steps.validation.outputs.validation_job_id }}"
          databricks jobs delete --job-id ${{ steps.validation.outputs.validation_job_id }} || echo "Failed to delete job"
        fi

    - name: Create validation report
      if: always()
      run: |
        echo "## Data Validation Report" > validation_report.md
        echo "" >> validation_report.md
        echo "**Environment:** ${{ github.event.inputs.environment || 'prod' }}" >> validation_report.md
        echo "**Tickers:** ${{ github.event.inputs.tickers || 'AAPL,MSFT,GOOGL,AMZN,META' }}" >> validation_report.md
        echo "**Timestamp:** $(date -u)" >> validation_report.md
        echo "" >> validation_report.md
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "**Status:** ✅ PASSED" >> validation_report.md
          echo "" >> validation_report.md
          echo "All data quality checks passed successfully:" >> validation_report.md
          echo "- ✅ No missing feature columns" >> validation_report.md
          echo "- ✅ Null counts minimal" >> validation_report.md
          echo "- ✅ Outlier count reasonable" >> validation_report.md
        else
          echo "**Status:** ❌ FAILED" >> validation_report.md
          echo "" >> validation_report.md
          echo "Data validation failed. Please check the logs for details." >> validation_report.md
        fi

    - name: Upload validation report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: validation-report-${{ github.event.inputs.environment || 'prod' }}
        path: validation_report.md
        retention-days: 30